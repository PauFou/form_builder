# Runtime Viewer - Development Dockerfile (Optimized)
FROM node:20-alpine

# Install pnpm (version 9+)
RUN corepack enable && corepack prepare pnpm@latest --activate

# Set working directory
WORKDIR /app

# Copy workspace configuration
COPY pnpm-workspace.yaml ./
COPY .npmrc* ./

# Set environment to skip Playwright browser download
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# Copy package files for dependency installation
COPY package.json pnpm-lock.yaml ./
COPY packages/runtime/package.json ./packages/runtime/
COPY packages/ui/package.json ./packages/ui/
COPY packages/config/package.json ./packages/config/

# Install dependencies
RUN pnpm install --frozen-lockfile --prefer-offline

# Copy source code (only what's needed)
COPY packages/runtime ./packages/runtime
COPY packages/ui ./packages/ui
COPY packages/config ./packages/config
COPY turbo.json ./

# Expose port
EXPOSE 3001

# Set environment
ENV NODE_ENV=development

# Start development watcher (runtime is a library, not a server)
CMD ["pnpm", "--filter", "@skemya/runtime", "dev"]
